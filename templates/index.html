{% extends "base.html" %}

{% block favicon_stylesheet %} {{ super() }} {% endblock %}
{% block title %} {{ super() }} {% endblock %}

{% block body %}
    <div id="project-dir-setup">
        {% with messages = get_flashed_messages() %} {% if messages %}
                    {% for message in messages %}
                        <div>{{ message| safe}}</div>
                    {% endfor %}
            {% endif %} {% endwith %}
        <div class="dir-clarification">
            {% if path %}
                Data directory: <span id="project-dir-path" class="path">{{ path }}</span>
                <button id="show-project-form-button"
                        class="btn btn-outline-primary btn-sm shw-btn"
                        data-toggle="collapse"
                        data-target="#project-dir-form">Change...</button>
            {% else %}
                Create a project directory (or enter a previously created one).
            {% endif %}
            <form id="project-dir-form" class="collapse form-inline"
                  action="{{ url_for('setup_project_dir') }}" method=post>
                <div id="project-dir-input-group" class="col-md-3">
                    <input id="project-dir-input" class="form-control" name="project-dir"
                           placeholder="Directory path..." pattern="[^/?<>|*]+" required>
                    <input class="form-control" type="submit" value="Submit">
                </div>
            </form>
            <script>
                var projectDirInput = document.querySelector("#project-dir-input");
                projectDirInput.addEventListener(
                    "invalid",
                    function() {
                        if (projectDirInput.value != "") {
                            projectDirInput.setCustomValidity(
                                "Characters \/?<>|*\" are not allowed.");
                    }})
                projectDirInput.addEventListener(
                    "input",
                    function(){ projectDirInput.setCustomValidity(""); });
                document.getElementById('project-dir-input').focus();
                {% if path %}
                        $("#project-dir-form").on("submit", function(event){
                            var newDirValue = $("#project-dir-input").val();
                            if (newDirValue != $("#project-dir-path").html()) {
                                confirm('Switch to ' + newDirValue + '?\nThe old one and its data will still be there.')
                            } else {
                                var dirInputGroup = $("#project-dir-input-group");
                                event.preventDefault();
                                if (dirInputGroup.children().length == 2) {
                                    var sameDirError = $("<div>Already set to this directory</div>").css('color', 'red');
                                    dirInputGroup.append(sameDirError);
                                    setTimeout(function(){ sameDirError.remove(); }, 2000);
                                }
                            }
                        });
                    var show_btn = $("#show-project-form-button");
                    show_btn.on(
                        'click',
                        function(){
                            if (show_btn.html() == 'Change...') {
                                show_btn.html('Cancel');
                                setTimeout(
                                    function(){$("#project-dir-input").focus()}, 1);}
                            else {
                                show_btn.html('Change...')}
                            });
                {% else %}
                    $("#project-dir-form").removeClass('collapse');
                    $("#project-dir-form input[name='project-dir']")[0].focus();
                {% endif %}
            </script>
        </div>
    </div>
{% endblock %}